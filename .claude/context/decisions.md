---
created: 2025-09-06
version: 1.0.0
author: Claude (context-creation)
---

# 技术决策记录 (ADR - Architecture Decision Records)

## ADR 格式说明

每个决策记录包含：
- **状态**: Accepted（已接受）、Deprecated（已废弃）、Superseded（已替代）
- **决策者**: 做出决策的人员或团队
- **决策日期**: 做出决策的时间
- **技术背景**: 导致此决策的技术环境
- **决策内容**: 具体的技术选择
- **决策原因**: 选择此方案的理由
- **后果**: 此决策的影响和权衡

---

## ADR-001: CLI 框架选择 - Commander.js

**状态**: ✅ Accepted  
**决策者**: 核心开发团队  
**决策日期**: 2024-02-15  

### 技术背景
需要选择一个成熟的 Node.js CLI 框架来构建 CCVM 命令行工具。

### 决策内容
选择 **Commander.js v11.1.0** 作为主要 CLI 框架。

### 决策原因
- **成熟稳定**: 广泛使用，社区支持良好
- **功能完整**: 支持子命令、选项解析、帮助生成
- **轻量级**: 最小依赖，启动速度快
- **文档完善**: 官方文档详细，学习成本低
- **TypeScript 支持**: 良好的类型定义

### 后果
- ✅ 快速原型开发，减少了框架学习成本
- ✅ 标准化的命令行界面体验
- ⚠️ 被锁定在 Commander.js 的 API 设计上
- ⚠️ 需要处理复杂交互时可能需要额外的库

---

## ADR-002: 配置存储架构 - JSON 文件系统

**状态**: ✅ Accepted  
**决策者**: 核心开发团队  
**决策日期**: 2024-03-10  

### 技术背景
需要设计一个安全、可靠的配置存储系统来管理 API 提供商配置和系统设置。

### 决策内容
采用 **基于 JSON 文件的分层存储架构**：
```
~/.claude/ccvm/
├── config.json        # 系统配置
├── history.json       # 操作历史
└── providers/         # 提供商配置目录
    ├── anthropic.json
    └── custom.json
```

### 决策原因
- **简单直观**: JSON 格式易读易写，便于调试
- **版本控制友好**: 文件格式便于 diff 和追踪变更
- **权限控制**: 可以精确控制文件权限（600）
- **跨平台兼容**: 无需外部数据库依赖
- **原子操作**: 配合文件锁实现安全的并发访问

### 后果
- ✅ 开发和调试简单，无外部依赖
- ✅ 用户可以直接查看和手动编辑配置
- ✅ 备份和恢复操作简单
- ⚠️ 大量配置时性能可能受限
- ⚠️ 需要自行实现并发控制和数据完整性

---

## ADR-003: 安全模型 - 文件权限 + HTTPS 验证

**状态**: ✅ Accepted  
**决策者**: 核心开发团队  
**决策日期**: 2024-03-20  

### 技术背景
需要确保 API 密钥和敏感配置的安全存储，同时保证网络通信安全。

### 决策内容
实施 **双重安全机制**：
1. **文件权限控制**: 所有配置文件设置为 600 权限
2. **HTTPS 强制验证**: 除本地和私有网络外强制使用 HTTPS

### 决策原因
- **纵深防御**: 多层安全保护
- **系统原生**: 利用操作系统的权限机制
- **网络安全**: 防止中间人攻击和数据泄露
- **灵活性**: 允许开发环境的灵活配置

### 后果
- ✅ 有效保护 API 密钥安全
- ✅ 符合安全最佳实践
- ✅ 支持开发和生产环境差异化
- ⚠️ 增加了配置复杂度
- ⚠️ 需要处理权限设置的跨平台差异

---

## ADR-004: Shell 集成策略 - 环境变量动态加载

**状态**: ✅ Accepted  
**决策者**: 核心开发团队  
**决策日期**: 2024-04-15  

### 技术背景
需要实现与原生 `claude` 命令的无缝集成，允许用户快速切换不同的 API 提供商。

### 决策内容
采用 **动态环境变量加载策略**：
```bash
# 动态加载环境变量
eval "$(ccvm env)"
claude "your prompt"

# 临时切换提供商
eval "$(ccvm env --provider custom)"
claude "using custom provider"
```

### 决策原因
- **无侵入性**: 不修改 claude 命令本身
- **灵活性**: 支持临时和永久切换
- **Shell 兼容**: 支持 bash、zsh、fish 等多种 Shell
- **安全性**: 环境变量仅在当前 Shell 会话有效

### 后果
- ✅ 用户体验流畅，学习成本低
- ✅ 与现有工作流完美集成
- ✅ 支持多种 Shell 环境
- ⚠️ 需要用户手动执行 eval 命令
- ⚠️ 环境变量污染需要谨慎处理

---

## ADR-005: 三层架构设计

**状态**: ✅ Accepted  
**决策者**: 核心开发团队  
**决策日期**: 2024-05-20  

### 技术背景
随着功能复杂度增加，需要建立清晰的代码组织结构和职责分离。

### 决策内容
采用 **三层架构模式**：
1. **CLI 层** (bin/): 用户界面和命令解析
2. **业务逻辑层** (src/core/): 核心业务管理器
3. **工具层** (src/utils/): 通用工具和服务

### 决策原因
- **职责清晰**: 每层有明确的职责边界
- **可测试性**: 便于单元测试和模拟
- **可维护性**: 代码组织清晰，便于维护
- **可扩展性**: 易于添加新功能和模块

### 后果
- ✅ 代码结构清晰，易于理解和维护
- ✅ 测试覆盖更容易实现
- ✅ 功能扩展更加规范
- ⚠️ 增加了一定的代码复杂度
- ⚠️ 需要维护层间接口的稳定性

---

## ADR-006: MCP 服务集成架构

**状态**: ✅ Accepted  
**决策者**: 核心开发团队  
**决策日期**: 2024-08-10  

### 技术背景
Claude Code 引入 MCP (Model Context Protocol) 服务支持，需要集成和管理各种 MCP 服务。

### 决策内容
开发 **MCPManager** 专门管理 MCP 服务：
- 交互式服务配置
- 统一的服务启用/禁用
- 与 Claude Code 配置的直接集成

### 决策原因
- **专业化**: 专门的管理器处理 MCP 相关逻辑
- **用户体验**: 交互式配置降低使用门槛
- **集成性**: 与 Claude Code 深度集成
- **扩展性**: 支持新的 MCP 服务类型

### 后果
- ✅ MCP 服务管理标准化
- ✅ 用户配置体验优化
- ✅ 为未来 MCP 服务扩展奠定基础
- ⚠️ 增加了系统复杂度
- ⚠️ 需要跟随 MCP 标准的演进

---

## ADR-007: 测试策略 - Jest + 分层测试

**状态**: ✅ Accepted  
**决策者**: 核心开发团队  
**决策日期**: 2024-09-01  

### 技术背景
需要建立全面的测试体系确保代码质量和功能稳定性。

### 决策内容
采用 **Jest 框架 + 分层测试策略**：
- **单元测试**: 覆盖所有核心模块
- **集成测试**: 端到端 CLI 测试
- **性能测试**: 启动时间和内存使用基准

### 决策原因
- **生态成熟**: Jest 是 Node.js 生态的标准测试框架
- **功能全面**: 内置断言、模拟、覆盖率报告
- **配置简单**: 零配置启动，易于设置
- **快照测试**: 适合 CLI 输出测试

### 后果
- ✅ 建立了完整的质量保证体系
- ✅ 70%+ 的测试覆盖率
- ✅ 自动化的回归测试
- ⚠️ 测试维护成本
- ⚠️ 需要持续投入测试用例开发

---

## ADR-008: 错误处理策略 - 结构化错误管理

**状态**: ✅ Accepted  
**决策者**: 核心开发团队  
**决策日期**: 2024-09-05  

### 技术背景
需要提供一致、用户友好的错误处理和反馈机制。

### 决策内容
实施 **结构化错误管理系统**：
- 标准化错误码和消息
- 分层错误处理策略
- 用户友好的错误提示和建议

### 决策原因
- **一致性**: 统一的错误处理方式
- **用户体验**: 提供可操作的错误信息
- **调试友好**: 结构化的错误信息便于诊断
- **国际化准备**: 为多语言支持做准备

### 后果
- ✅ 改善了用户体验和错误诊断
- ✅ 降低了用户支持成本
- ✅ 建立了可扩展的错误处理架构
- ⚠️ 增加了错误处理代码的复杂度
- ⚠️ 需要维护错误消息的准确性

---

## ADR-009: Chrome Browser MCP 集成策略

**状态**: ✅ Accepted  
**决策日期**: 2025-09-09  
**决策者**: CCVM Development Team  

### 问题描述
Chrome MCP是一个浏览器自动化工具，需要Chrome扩展配合工作，其安装和配置流程比其他MCP服务更加复杂，需要特殊的集成方案。

### 决策
实施 **Chrome MCP 特殊集成模式**：
- 使用SSE传输协议连接HTTP服务
- 实现专用的安装向导 (`installChromeMCP`)
- 提供连接测试和验证机制 (`testMCPConnection`)
- 包含完整的用户指导和故障排除

### 决策原因
- **用户价值**: Chrome自动化功能对用户价值很高
- **技术可行性**: HTTP/SSE连接方式成熟稳定
- **用户体验**: 通过向导简化复杂的安装过程
- **扩展性**: 为其他类似复杂MCP服务提供参考模式

### 技术实现
```javascript
// 配置结构
'chrome-browser': {
  transport: 'sse',
  requiresManualSetup: true,
  setupInstructions: [...],
  configFields: [...],
  // 特殊处理逻辑
}

// 安装流程
async installChromeMCP(mcp) {
  // 5步安装向导
  // 1. npm包检查和安装
  // 2. Chrome扩展确认
  // 3. MCP服务连接测试
  // 4. URL配置
  // 5. Claude Code集成
}
```

### 后果
- ✅ 成功集成复杂的浏览器自动化功能
- ✅ 建立了复杂MCP服务的集成模式
- ✅ 提升了用户对CCVM功能丰富性的认知
- ⚠️ 增加了安装流程的复杂性
- ⚠️ 需要维护Chrome扩展兼容性

---

## ADR-011: 简化安装脚本和移除历史兼容代码
- **状态**: 已决定并实施
- **日期**: 2025-09-09
- **决策者**: 开发团队

### 背景
安装脚本(install.sh)中包含了大量历史兼容代码：
- `migrate_old_config`: 从 ~/.ccvm 迁移到 ~/.claude/ccvm
- `backup_existing_config`: 备份现有Claude配置
- `backup_directory`: 备份辅助函数

这些代码已经不再需要，因为：
- 新用户不会有旧配置需要迁移
- 老用户已经完成迁移
- 安装脚本不会覆盖用户配置，无需备份

### 决策
**移除所有历史兼容代码**，简化安装流程：
1. 删除迁移和备份相关函数
2. 优化开发模式npm install逻辑
3. 改进Chrome MCP路径检测算法

### 技术改进
```bash
# 开发模式智能npm检测
if [[ ! -d "$SCRIPT_DIR/node_modules" ]]; then
    npm install  # 仅在需要时安装
fi

# Chrome MCP路径检测增强
- 使用 npm list -g 精确获取路径
- 支持nvm等版本管理器
- 提供fallback搜索机制
```

### 后果
- ✅ 代码量减少30行，提高可维护性
- ✅ 安装速度提升（跳过不必要的检查）
- ✅ 解决了nvm环境下的路径检测问题
- ✅ 代码逻辑更清晰简洁
- ⚠️ 不再支持从旧版本迁移（可接受）

### 依赖
- Chrome/Chromium浏览器
- mcp-chrome-bridge npm包
- hangwin/mcp-chrome GitHub项目

---

## 废弃的决策

### ADR-003-DEPRECATED: 原 exec 命令设计

**状态**: ❌ Deprecated  
**决策日期**: 2024-07-20  
**废弃日期**: 2024-08-15  

**原决策**: 实现 `ccvm exec` 命令来执行带有特定提供商配置的命令。

**废弃原因**: 
- 用户体验不如环境变量方案直观
- 增加了不必要的复杂度
- 与 Shell 集成的方式更加自然

**替代方案**: 采用 `ccvm env` 环境变量动态加载策略 (ADR-004)。

---

## ADR-012: WeComBot MCP 集成

**状态**: ✅ Accepted  
**决策日期**: 2025-09-10  
**决策者**: CCVM Development Team  

### 问题描述
用户需要通过Claude与企业微信群进行自动化交互，发送各种类型的消息（文本、markdown、图片、新闻卡片等）。

### 决策
添加 **WeComBot MCP服务** 到CCVM的MCP服务注册表中：
- 包名：`@kedoupi/wecombot-mcp`
- 传输方式：stdio (标准MCP协议)
- 配置要求：企业微信机器人Webhook URL
- 功能特性：支持多种消息类型（文本、markdown、图片、新闻卡片）

### 决策原因
- **用户需求**: 企业用户对企业微信自动化有实际需求
- **技术成熟**: MCP协议标准化，集成简单可靠
- **扩展价值**: 为CCVM增加企业办公自动化能力
- **维护成本低**: 使用标准stdio传输，配置简单

### 技术实现
```javascript
'wecombot': {
  name: 'wecombot',
  displayName: 'WeComBot MCP',
  description: '向企业微信群发送消息，支持文本、markdown、图片等多种消息类型',
  package: '@kedoupi/wecombot-mcp',
  transport: 'stdio',
  recommended: true,
  needsConfig: true,
  configFields: [
    {
      name: 'webhook_url',
      message: '请输入企业微信机器人Webhook URL:',
      validate: validateWeComWebhookURL
    }
  ]
}
```

### 后果
- ✅ 扩展了CCVM的企业办公自动化能力
- ✅ 为用户提供了企业微信集成解决方案
- ✅ 遵循了CCVM的MCP服务集成标准
- ✅ 保持了配置和使用的一致性

---

## 决策审查计划

### 定期审查
每个季度审查现有决策的有效性：
- 技术环境变化的影响
- 用户反馈和需求变化
- 新技术和最佳实践的出现

### 下次审查日期
**2025-12-06** - 年度架构决策审查

### 待审查决策
1. CLI 框架选择 (是否需要升级或替换)
2. 配置存储架构 (性能和扩展性评估)
3. MCP 服务集成架构 (随 MCP 标准演进调整)