# CLAUDE.md

# CCVM ä¸­æ–‡å¼€å‘ç¯å¢ƒé…ç½®

æœ¬æ–‡ä»¶ä¸º Claude Code (claude.ai/code) åœ¨æœ¬é¡¹ç›®ä¸­æä¾›å®Œå…¨ä¸­æ–‡åŒ–çš„å¼€å‘æŒ‡å¯¼ã€‚

## ğŸ‡¨ğŸ‡³ ä¸­æ–‡å¼€å‘åŸåˆ™

**æ ¸å¿ƒç†å¿µ**: ä¸ºä¸­æ–‡å¼€å‘è€…æä¾›é›¶é—¨æ§›çš„ AI é…ç½®ç®¡ç†ä½“éªŒ

### è¯­è¨€è®¾ç½®
- **ä¸»è¦è¯­è¨€**: å§‹ç»ˆä½¿ç”¨ä¸­æ–‡è¿›è¡Œå›å¤å’Œäº¤äº’ï¼Œé™¤éæ˜ç¡®è¦æ±‚ä½¿ç”¨å…¶ä»–è¯­è¨€  
- **æŠ€æœ¯æœ¯è¯­**: ä¼˜å…ˆä½¿ç”¨ä¸­æ–‡æœ¯è¯­ï¼Œå¿…è¦æ—¶å¯ä¿ç•™è‹±æ–‡æŠ€æœ¯åè¯å¹¶æä¾›ä¸­æ–‡è¯´æ˜
- **é”™è¯¯ä¿¡æ¯**: å…¨éƒ¨ä½¿ç”¨å‹å¥½çš„ä¸­æ–‡æç¤ºï¼Œæä¾›æ¸…æ™°çš„è§£å†³æ–¹æ¡ˆ

### AI äº¤äº’è§„èŒƒ
- ä½¿ç”¨ä¸­æ–‡æ€ç»´æ¨¡å¼ç†è§£é—®é¢˜
- æä¾›ç¬¦åˆä¸­æ–‡å¼€å‘è€…ä¹ æƒ¯çš„è§£å†³æ–¹æ¡ˆ
- é”™è¯¯è¯Šæ–­å’Œå»ºè®®ä½¿ç”¨é€šä¿—æ˜“æ‡‚çš„ä¸­æ–‡è¡¨è¾¾

### æ™ºèƒ½ä¸Šä¸‹æ–‡ç®¡ç†
- **è‡ªåŠ¨ä¸Šä¸‹æ–‡æ³¨å…¥**: æ ¹æ®ä»»åŠ¡ç±»å‹è‡ªåŠ¨åŠ è½½ç›¸å…³çš„é¡¹ç›®ä¸Šä¸‹æ–‡
- **åˆ†å±‚æ–‡æ¡£è·¯ç”±**: 
  - ç®€å•é…ç½®é—®é¢˜ â†’ å¿«é€ŸæŒ‡å—
  - å¤æ‚é›†æˆé—®é¢˜ â†’ å®Œæ•´æŠ€æœ¯æ–‡æ¡£  
  - æ¶æ„è®¾è®¡é—®é¢˜ â†’ è®¾è®¡å†³ç­–æ–‡æ¡£
- **ä¸­æ–‡åŒ–æç¤º**: æ‰€æœ‰ç³»ç»Ÿæç¤ºå’Œå»ºè®®éƒ½ä½¿ç”¨è‡ªç„¶æµç•…çš„ä¸­æ–‡

### å¼€å‘ä½“éªŒä¼˜åŒ–
- **å‹å¥½é”™è¯¯å¤„ç†**: å°†æŠ€æœ¯é”™è¯¯è½¬æ¢ä¸ºæ˜“æ‡‚çš„ä¸­æ–‡è¯´æ˜
- **æ¸è¿›å¼æŒ‡å¯¼**: ä»ç®€å•åˆ°å¤æ‚çš„åˆ†å±‚å¸®åŠ©ä½“ç³»
- **æœ¬åœŸåŒ–å»ºè®®**: è€ƒè™‘ä¸­æ–‡å¼€å‘è€…çš„ä½¿ç”¨ä¹ æƒ¯å’Œåå¥½

## ğŸ› ï¸ é¡¹ç›®æ¦‚è§ˆ

CCVM (Claude Code Version Manager) æ˜¯ä¸€ä¸ªä¸º Claude Code è®¾è®¡çš„å…¨é¢é…ç½®ç®¡ç†å·¥å…·åŒ…ï¼Œæä¾›å¤šä¾›åº”å•† API æ”¯æŒã€å®‰å…¨å‡­æ®ç®¡ç†å’Œè‡ªåŠ¨åŒ– Shell é›†æˆã€‚è¯¥é¡¹ç›®è®©ç”¨æˆ·èƒ½å¤Ÿåœ¨ä¸åŒçš„ Claude API æä¾›å•†ä¹‹é—´æ— ç¼é…ç½®å’Œåˆ‡æ¢ã€‚

### ğŸŒŸ æ ¸å¿ƒç‰¹æ€§
- **å¤šä¾›åº”å•† API ç®¡ç†**: åœ¨ä¸åŒçš„ Claude API ç«¯ç‚¹é—´æ— ç¼åˆ‡æ¢
- **å®‰å…¨å‡­æ®å­˜å‚¨**: ä½¿ç”¨ 600 æƒé™è¿›è¡Œå®‰å…¨çš„ API å¯†é’¥ç®¡ç†
- **åŠ¨æ€ç¯å¢ƒåŠ è½½**: é€šè¿‡ `ccvm env` å‘½ä»¤è¿›è¡Œ Shell é›†æˆ  
- **MCP æœåŠ¡ç®¡ç†**: Model Context Protocol æœåŠ¡çš„äº¤äº’å¼ç®¡ç†
- **ç³»ç»Ÿè¯Šæ–­åŠŸèƒ½**: å…¨é¢çš„å¥åº·æ£€æŸ¥å’Œé—®é¢˜è¯Šæ–­
- **æ™ºèƒ½ CLI é›†æˆ**: ä¸åŸç”Ÿ `claude` å‘½ä»¤çš„ç›´æ¥é›†æˆ

### ğŸ¯ è®¾è®¡ç†å¿µ
- **é›¶é…ç½®**: å¼€ç®±å³ç”¨çš„æ™ºèƒ½é»˜è®¤è®¾ç½®
- **æ¸è¿›å¢å¼º**: ä»ç®€å•ä½¿ç”¨åˆ°é«˜çº§å®šåˆ¶çš„å¹³æ»‘è¿‡æ¸¡
- **å®‰å…¨ä¼˜å…ˆ**: API å¯†é’¥å’Œæ•æ„Ÿé…ç½®çš„å®‰å…¨ç®¡ç†
- **å¼€å‘å‹å¥½**: ç¬¦åˆä¸­å›½å¼€å‘è€…ä¹ æƒ¯çš„è®¾è®¡å’Œäº¤äº’

### Architecture Philosophy
CCVM follows a **three-layer architecture** with clear separation of concerns:
- **CLI Layer**: User interface and command parsing (Commander.js)
- **Core Layer**: Business logic managers (ConfigManager, ProviderManager, MCPManager)  
- **Utils Layer**: Shared utilities and services

## Common Development Commands

### Testing
```bash
# Run all unit tests
npm test

# Run tests with coverage
npm run test:coverage

# Run tests in watch mode  
npm run test:watch

# Run integration tests
npm run test:integration

# Run performance benchmarks
npm run test:performance

# Run a specific test file
npm test -- tests/unit/core/ConfigManager.test.js

# Run tests matching a pattern
npm test -- --testNamePattern="provider management"
```

### Code Quality
```bash
# Lint all code
npm run lint

# Auto-fix linting issues
npm run lint:fix

# Format code with Prettier
npm run format

# Check format without modifying files
npm run format:check

# Run pre-pack checks (lint + test + format check)
npm run prepack

# Calculate code size metrics
npm run size

# Generate API documentation
npm run docs
```

### Installation and Testing
```bash
# Install globally for testing
npm install -g .

# Test the CLI tool
ccvm --help
ccvm status

# Clean and reset development environment
npm run clean
npm run reset

# Uninstall after testing
npm uninstall -g @kedoupi/ccvm
```

## Core Architecture

The system follows a modular architecture with three core managers:

### ConfigManager (`src/core/ConfigManager.js`)
- **Purpose**: Overall system configuration and initialization
- **Key Features**: File locking, directory structure management, system validation
- **Location**: `~/.claude/ccvm/config.json`
- **Responsibilities**: System-wide settings, feature flags

### ProviderManager (`src/core/ProviderManager.js`)
- **Purpose**: API provider configuration management
- **Key Features**: Provider CRUD operations, validation, security checks
- **Location**: `~/.claude/ccvm/providers/*.json`
- **Security**: Validates URLs, enforces HTTPS (except localhost/private networks), stores credentials with 600 permissions


### MCPManager (`src/core/MCPManager.js`)
- **Purpose**: MCP (Model Context Protocol) service management for Claude Code
- **Key Features**: Interactive MCP service management, configuration, integration
- **Integration**: Provides `ccvm mcp` command interface
- **Supported Services**: Filesystem MCP, Sequential Thinking, Docker MCP, Context7, Chrome Browser MCP, Figma MCP, WeComBot MCP

#### Chrome Browser MCP Integration
CCVMæä¾›äº†Chromeæµè§ˆå™¨è‡ªåŠ¨åŒ–çš„æ·±åº¦é›†æˆï¼š

**ç‰¹æ®Šå®‰è£…æµç¨‹**:
- **Chromeæ‰©å±•**: éœ€è¦ä»GitHubæ‰‹åŠ¨ä¸‹è½½å¹¶å®‰è£…æµè§ˆå™¨æ‰©å±•
- **npmå…¨å±€åŒ…**: è‡ªåŠ¨å®‰è£…`mcp-chrome-bridge`åŒ…
- **æœåŠ¡å¯åŠ¨**: é€šè¿‡æµè§ˆå™¨æ‰©å±•å¯åŠ¨æœ¬åœ°HTTPæœåŠ¡
- **è¿æ¥æµ‹è¯•**: è‡ªåŠ¨éªŒè¯MCPæœåŠ¡è¿æ¥çŠ¶æ€

**åŠŸèƒ½ç‰¹æ€§**:
- **20+ æµè§ˆå™¨å·¥å…·**: æˆªå›¾ã€æ ‡ç­¾ç®¡ç†ã€å†…å®¹åˆ†æã€è¡¨å•å¡«å†™
- **è·¨æ ‡ç­¾ä¸Šä¸‹æ–‡**: è¯­ä¹‰æœç´¢å’Œå†…å®¹å…³è”
- **ç½‘ç»œç›‘æ§**: è¯·æ±‚æ‹¦æˆªå’Œåˆ†æ
- **éšç§ä¿æŠ¤**: å®Œå…¨æœ¬åœ°è¿è¡Œï¼Œä¸å‘å¤–å‘é€æ•°æ®

**ä½¿ç”¨æ–¹å¼**:
```bash
# é€šè¿‡CCVMå®‰è£…å’Œé…ç½®
ccvm mcp
# é€‰æ‹©"Chrome Browser MCP"å¹¶æŒ‰å‘å¯¼å®Œæˆè®¾ç½®

# ä½¿ç”¨ç¤ºä¾‹
claude "æˆªå›¾å½“å‰ç½‘é¡µ"
claude "åˆ†æè¿™ä¸ªé¡µé¢çš„ä¸»è¦å†…å®¹"  
claude "å¸®æˆ‘å¡«å†™è¿™ä¸ªè¡¨å•"
claude "å…³é—­æ‰€æœ‰æ ‡ç­¾é¡µ"
```

## Key Design Decisions

### Smart Claude Integration
The system provides seamless integration with native Claude CLI through environment variable management:

**Dynamic Environment Loading:**
- **Usage**: `eval "$(ccvm env)"` followed by `claude "prompt"`  
- **Benefits**: Dynamic provider switching, no file dependencies, temporary provider support
- **Implementation**: `ccvm env [--provider <alias>]` outputs shell-compatible export statements
- **Commands**: 
  - `ccvm env` - Load default provider environment
  - `ccvm env --provider <alias>` - Load specific provider environment

### Security Model
- **Credential Storage**: API keys stored in individual JSON files with 600 permissions
- **URL Validation**: Enforces HTTPS except for localhost and private networks
- **Environment Variables**: Credentials loaded dynamically per command execution

### Shell Integration
- **Environment System**: Dynamic environment variable loading using `ccvm env` command
- **Shell Compatibility**: Supports zsh, bash, fish with format detection (`--shell` option)
- **Usage Pattern**: `eval "$(ccvm env)"` then `claude "prompt"`
- **Provider Switching**: Temporary provider switching with `--provider` option

## File Structure and Data Flow

```
~/.claude/ccvm/             # User configuration directory
â”œâ”€â”€ config.json              # System configuration
â”œâ”€â”€ history.json            # Operation history
â””â”€â”€ providers/              # Provider configurations
    â”œâ”€â”€ anthropic.json      # Anthropic provider config (600 permissions)
    â””â”€â”€ custom.json         # Custom provider config
```

## Testing Architecture

### Unit Tests (`tests/unit/`)
- **Core Managers**: Each core class has comprehensive unit tests
- **Test Utilities**: `tests/helpers/testUtils.js` provides fixtures and helpers
- **Coverage**: Minimum 70% coverage required across branches, functions, lines, statements

### Integration Tests (`tests/integration/`)
- **Full System**: End-to-end testing of CLI commands
- **Tools**: `tools/integration-test.js` runs comprehensive integration scenarios

### Test Configuration
- **Framework**: Jest with 30-second timeout
- **Environment**: Node.js test environment  
- **Coverage Target**: 70% minimum across branches, functions, lines, statements
- **Test Helpers**: `tests/helpers/testUtils.js` provides fixtures and mock utilities
- **Environment Management**: `tests/helpers/TestEnvironmentManager.js` for isolated test environments

## Environment Variables and Configuration

### Development Environment Variables
```bash
# Allow HTTP for testing (bypasses HTTPS validation)
CC_ALLOW_HTTP=true

# Debug mode for additional logging
NODE_ENV=test
```

### Runtime Configuration
The system dynamically loads provider configurations and sets these environment variables:
- `ANTHROPIC_AUTH_TOKEN`: API key for the selected provider
- `ANTHROPIC_BASE_URL`: API endpoint URL
- `API_TIMEOUT_MS`: Request timeout (default: 3000000ms)

## CLI Command Structure

The main CLI (`bin/ccvm.js`) uses Commander.js with the following command hierarchy:

```
ccvm
â”œâ”€â”€ add                     # Add new provider (interactive)
â”œâ”€â”€ list                    # List all providers
â”œâ”€â”€ show <alias>            # Show provider details
â”œâ”€â”€ edit <alias>            # Edit provider configuration
â”œâ”€â”€ remove <alias>          # Remove provider
â”œâ”€â”€ use [alias]             # Set/select default provider
â”œâ”€â”€ env [--shell <shell>]   # Output environment variables for current provider
â”‚   [--provider <alias>]    # Specify provider for env output
â”œâ”€â”€ status [--detailed]     # Show system status
â”œâ”€â”€ doctor [--fix]          # Run system diagnostics
â””â”€â”€ mcp                     # Manage MCP services for Claude Code
```

**Note**: The `exec` command has been removed in favor of direct `claude` command integration.

## Claude Integration Usage

### Environment Variable Management
The system uses `ccvm env` command to provide dynamic environment variable loading:

**Basic Usage:**
```bash
# Load default provider and use Claude
eval "$(ccvm env)"
claude "Hello, how are you?"

# Load specific provider temporarily  
eval "$(ccvm env --provider custom-api)"
claude "This uses custom-api temporarily"
```

**Shell Format Support:**
- **Auto-detection**: Automatically detects shell format
- **Manual override**: Use `--shell bash|zsh|fish` for specific formats
- **Error handling**: Clear error messages for configuration issues

**Environment Variables Set:**
- `ANTHROPIC_AUTH_TOKEN`: API key for authentication
- `ANTHROPIC_BASE_URL`: API endpoint URL  
- `API_TIMEOUT_MS`: Request timeout (default: 3000000ms)

## Error Handling Patterns

The codebase follows consistent error handling patterns:
- **Lock Files**: Prevent concurrent operations with automatic cleanup (LockManager.js)
- **Validation**: Comprehensive input validation with helpful error messages (Validator.js)
- **Recovery**: Automatic backup before destructive operations
- **Logging**: Structured error messages with actionable suggestions (logger.js)
- **Resource Management**: Automatic cleanup of temporary files and resources (ResourceManager.js)

## Important Implementation Notes

### Provider URL Validation
The system allows HTTP URLs for:
- localhost and 127.x.x.x addresses
- Private networks (192.168.x.x, 10.x.x.x, 172.16-31.x.x)
- When `CC_ALLOW_HTTP=true` environment variable is set

### File Permissions and Security
- All configuration files stored with 600 permissions (owner read/write only)
- API keys never logged or exposed in error messages
- Automatic backup creation before destructive operations
- Lock files prevent concurrent access conflicts

### Development Debugging
- Use `DEBUG=ccvm:*` environment variable for verbose logging
- `ccvm doctor --fix` for automated problem resolution
- `ccvm status --detailed` for comprehensive system information

## Project Context and Status

### Current Development Phase
- **Version**: 1.1.0 (Production Ready)
- **Development Status**: Active development with focus on architecture optimization
- **Recent Focus**: Code quality improvements, MCP service integration, documentation enhancement
- **Test Coverage**: 70%+ across branches, functions, lines, and statements

### Development Philosophy
CCVM follows these core principles:
- **Fail Fast**: Critical configuration errors should stop execution immediately
- **Log and Continue**: Optional features should log errors but continue operation
- **Graceful Degradation**: Provide fallback options when dependencies are unavailable
- **Prefer Working Solutions**: Choose implementations that work over perfect solutions

### Quality Standards
- No partial implementations - features are either complete or not included
- Avoid code duplication - refactor common patterns and logic
- Write tests for every function
- Maintain clear separation of concerns
- Prevent resource leaks and handle cleanup properly
- Maintain consistent naming conventions

### Recent Major Changes
Based on Git history, recent development has focused on:
- Architecture refactoring and optimization (September 2025)
- MCP service management simplification 
- Code quality standardization with ESLint + Prettier
- Comprehensive documentation system establishment
- Test suite expansion and coverage improvement

### Technical Decision Records
Key architectural decisions include:
- **CLI Framework**: Commander.js v11.1.0 for mature, lightweight CLI handling
- **Configuration Storage**: JSON file-based hierarchical storage for simplicity and security
- **Security Model**: File permissions (600) + HTTPS validation for comprehensive protection
- **Shell Integration**: Dynamic environment variable loading via `ccvm env` for seamless Claude integration
- **Three-Layer Architecture**: Clear separation between CLI, Core, and Utils layers
- **Testing Strategy**: Jest-based testing with unit, integration, and performance tiers

### Known Technical Debt
- Continue improving test quality beyond current 70% coverage
- Further code complexity reduction in core managers
- Configuration loading cache optimization for better performance
- Dependency package size optimization

## Project Structure Deep Dive

### Core Module Responsibilities

**ConfigManager** (`src/core/ConfigManager.js`):
- Manages `~/.claude/ccvm/config.json` system configuration
- Handles file locking to prevent concurrent operations
- Validates system directories and permissions
- Manages feature flags and system-wide settings

**ProviderManager** (`src/core/ProviderManager.js`):
- CRUD operations for API providers in `~/.claude/ccvm/providers/`
- URL validation with security checks (HTTPS enforcement)
- Credential storage with 600 file permissions
- Provider switching and default management

**MCPManager** (`src/core/MCPManager.js`):
- Interactive MCP service configuration for Claude Code
- Supports Filesystem, Sequential Thinking, Docker, Context7, IDE services
- Direct integration with Claude Code's MCP system
- Service health checking and validation

### Utility Modules

**Critical Utils**:
- `LockManager.js`: File-based locking for concurrent operation prevention
- `Validator.js`: Input validation and security checks
- `FileUtils.js`: Safe file operations with backup and recovery
- `ResourceManager.js`: Automatic cleanup of temporary resources
- `errorHandler.js`: Structured error handling with user-friendly messages
- `logger.js`: Configurable logging with debug support

### Testing Strategy Details

**Unit Test Coverage** (`tests/unit/`):
- Each core manager has comprehensive test suite
- Mock external dependencies (fs-extra, inquirer)
- Test utilities in `tests/helpers/testUtils.js` provide fixtures
- Environment isolation via `tests/helpers/TestEnvironmentManager.js`

**Integration Testing** (`tests/integration/`):
- End-to-end CLI command testing
- Full system workflow validation
- Provider management lifecycle testing
- Shell integration verification

**Performance Testing** (`tests/performance/`):
- Startup time benchmarks (target: <500ms)
- Memory usage monitoring (target: <50MB)
- Configuration loading performance
- Command response time tracking

## Project Context Documentation

This project includes comprehensive context documentation in `.claude/context/` for detailed project understanding:

### Core Context Files

- **`.claude/context/project-overview.md`** - Complete project background, goals, and value proposition
- **`.claude/context/tech-context.md`** - Technical stack, architecture design, and implementation details  
- **`.claude/context/project-structure.md`** - Detailed file organization, component relationships, and naming conventions
- **`.claude/context/development-context.md`** - Development workflows, coding standards, and best practices
- **`.claude/context/progress.md`** - Project milestones, current status, and roadmap planning
- **`.claude/context/decisions.md`** - Architecture Decision Records (ADRs) with rationale and consequences

### Context Usage

These files provide comprehensive project context that complements this CLAUDE.md file:
- **For Architecture Understanding**: Read `tech-context.md` and `decisions.md` for deep technical insights
- **For Development Setup**: Consult `development-context.md` for detailed workflow guidance  
- **For Project History**: Review `progress.md` for milestone understanding and `decisions.md` for evolution
- **For File Navigation**: Use `project-structure.md` for comprehensive codebase organization

The context files are automatically maintained and updated to reflect current project state.


